package Puzzle_Lab.Routes; import io.quarkus.mailer.Mail; import io.quarkus.mailer.Mailer; import jakarta.enterprise.context.ApplicationScoped; import jakarta.inject.Inject; import jakarta.transaction.Transactional; import jakarta.ws.rs.*; import jakarta.ws.rs.core.*; import java.security.SecureRandom; import java.util.Map; import Puzzle_Lab.Entities.User; import Puzzle_Lab.ResponseBody; /** * Handles password reset requests by generating a temporary password * and sending it to the user's email. */ @ApplicationScoped @Path("/send-email") @Produces(MediaType.APPLICATION_JSON) @Consumes(MediaType.APPLICATION_JSON) public class EmailResource { /** * Injects the Quarkus Mailer service to send emails. */ @Inject Mailer mailer; /** * Endpoint to handle forgot password requests. Generates a temporary password * and sends it to the user's email if the username and email match an existing user. * @param body A JSON payload containing "email" and "username". * @return A response indicating success or failure. */ @POST @Path("/forgot-password") @Transactional public Response sendResetPasswordEmail(Map<String, String> body) { String email = body.get("email"); // Validate input fields if (email == null) { return new ResponseBody(Response.Status.BAD_REQUEST) .addMessage("Missing 'email' field") .build(); } // Retrieve user by email and username from the database User user = User.find("email = ?1", email).firstResult(); if (user == null) { return new ResponseBody(Response.Status.NOT_FOUND) .addMessage("No user found with this email.") .build(); } // Generate a random temporary password String tempPassword = generateTempPassword(); user.setTempPassword(tempPassword); user.persist(); // Attempt to send the email with the temporary password try { mailer.send( Mail.withText(email, "Password Reset Request", "Hello " + user.getUsername() + ",\n\n" + "You have requested a password reset. Your temporary password (one time use) is:\n\n" + tempPassword + "\n\n" + "Please log in and change your password." ) ); // Return success response return new ResponseBody(Response.Status.OK) .addMessage("Temporary password sent successfully!") .build(); } catch (Exception e) { // Handle email sending failure e.printStackTrace(); return new ResponseBody(Response.Status.INTERNAL_SERVER_ERROR) .addMessage("Failed to send temporary password email.") .build(); } } /** * Generates a secure random 10-character temporary password using * uppercase, lowercase, and numeric characters. * @return A randomly generated temporary password. */ private String generateTempPassword() { SecureRandom random = new SecureRandom(); String characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; StringBuilder tempPassword = new StringBuilder(10); // Generate a 10-character random password for (int i = 0; i < 10; i++) { tempPassword.append(characters.charAt(random.nextInt(characters.length()))); } return tempPassword.toString(); } }
